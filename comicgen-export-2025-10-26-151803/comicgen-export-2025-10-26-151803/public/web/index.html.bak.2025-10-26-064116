<!doctype html><html lang="zh-CN"><meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ComicGen æ¼«ç”»ç”Ÿæˆ Â· æ˜äº®ç‰ˆ</title>
<style>
:root{
  --bg:#f6f8fb; --fg:#111827; --muted:#6b7280;
  --card:#ffffff; --border:#e5e7eb; --brand:#2563eb; --brand-2:#4f46e5;
  --ok:#10b981; --warn:#f59e0b; --danger:#ef4444;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.55 system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial}
header{
  background:linear-gradient(90deg,var(--brand),var(--brand-2));
  color:#fff; padding:16px 20px; position:sticky; top:0; z-index:10;
  box-shadow:0 4px 20px rgba(0,0,0,.12)
}
header h1{margin:0;font-size:20px}
.container{max-width:1280px;margin:20px auto;padding:0 16px}
.grid{
  display:grid; grid-template-columns: 480px 1fr; gap:16px;
}
@media (max-width: 980px){ .grid{grid-template-columns:1fr} }

.card{
  background:var(--card); border:1px solid var(--border);
  border-radius:14px; padding:14px; box-shadow:0 6px 20px rgba(0,0,0,.06)
}
h2{margin:0 0 10px 0; font-size:18px}
label{color:var(--muted); font-size:13px}
input,select,textarea{
  width:100%; border:1px solid var(--border); border-radius:10px; padding:10px; background:#fff; color:var(--fg)
}
button{
  appearance:none; border:1px solid var(--brand); color:#fff; background:var(--brand);
  border-radius:10px; padding:10px 14px; cursor:pointer; transition:.15s;
}
button:hover{filter:brightness(1.05)}
button.secondary{
  background:#fff; color:var(--brand); border-color:var(--brand)
}
.row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
.row>*{flex:1}
pre{
  white-space:pre-wrap; word-break:break-word; background:#fafafa; border:1px solid var(--border);
  border-radius:10px; padding:12px; max-height:380px; overflow:auto
}
.grid-tiles{ display:grid; grid-template-columns:repeat(2, minmax(0,1fr)); gap:12px }
@media (max-width:1200px){ .grid-tiles{ grid-template-columns:repeat(2,1fr) } }
@media (max-width:800px){ .grid-tiles{ grid-template-columns:1fr } }
.tile{
  border:1px dashed #d1d5db; border-radius:12px; padding:10px; background:#fff
}
.tile p{ margin:.25rem 0 .5rem 0; font-size:14px }
.tile img{ width:100%; height:auto; border-radius:10px; border:1px solid var(--border) }
.badge{font-size:12px; color:#fff; background:var(--brand); padding:2px 8px; border-radius:999px}
.help{color:var(--muted); font-size:12px}
.sticky{ position:sticky; top:78px }
.footer-card{margin-top:16px}
.kv{display:grid; grid-template-columns:120px 1fr; gap:8px; align-items:center}
hr{border:none; border-top:1px solid var(--border); margin:10px 0}
</style>
<body>
<header><h1>ğŸ“š ComicGen æ¼«ç”»ç”Ÿæˆï¼ˆæ˜äº®ç‰ˆ Â· å‰ç«¯å¹¶å‘æ¸²æŸ“ï¼‰</h1></header>
<div class="container grid">

  <!-- å·¦ä¾§ï¼šå°è¯´åˆ†é•œ -->
  <section class="card">
    <h2>â‘  å°è¯´ â†’ åˆ†é•œ <span class="badge">LLM</span></h2>
    <div class="kv" style="margin-top:8px">
      <label>ç”»é£</label>
      <select id="style">
        <option>é»‘ç™½çº¿ç¨¿</option>
        <option>é’å¹´çƒ­è¡€</option>
        <option>æ—¥ç³»æ¸…æ–°</option>
        <option>å†™å®é˜´å½±</option>
      </select>
      <label>å°è¯´ç‰‡æ®µ</label>
      <div><textarea id="novel" rows="10" placeholder="ç²˜è´´ä¸­æ–‡å°è¯´ç‰‡æ®µï¼Œå›è½¦æ¢è¡Œå‡å¯"></textarea></div>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="btnSb">ç”Ÿæˆåˆ†é•œ JSON</button>
      <button id="btnClear" class="secondary" title="æ¸…ç©ºåˆ†é•œä¸å³ä¾§æ¸²æŸ“åŒº">æ¸…ç©º</button>
    </div>
    <pre id="sbout" style="margin-top:10px">(ç­‰å¾…ç”Ÿæˆ...)</pre>
    <p class="help">æç¤ºï¼šå¦‚æœä½ æƒ³å›ºå®šæ ¼æ•°ï¼Œå¯åœ¨å°è¯´é¦–è¡Œå†™â€œã€è¦æ±‚ã€‘ä¸€é¡µ 2x2 å…± 4 æ ¼â€ã€‚</p>
  </section>

  <!-- å³ä¾§ï¼šæ¸²æŸ“æ§åˆ¶ï¼ˆç½®é¡¶å¸é™„ï¼‰ + æ¸²æŸ“ç»“æœç½‘æ ¼ -->
  <section class="card sticky">
    <h2>â‘¡ æ‰¹é‡æ¸²æŸ“æ§åˆ¶ <span class="badge">å‰ç«¯å¹¶å‘</span></h2>
    <div class="kv" style="margin-top:6px">
      <label>å°ºå¯¸</label>
      <select id="sizeBatch">
        <option>1024x1024</option>
        <option>768x1344</option>
        <option>1344x768</option>
      </select>
      <label>å¹¶å‘æ•°</label>
      <input id="concurrency" type="number" min="1" max="6" value="3"/>
      <label>ç»Ÿä¸€ç”»é£å‰ç¼€</label>
      <input id="pprefix" value="black and white manga, line art, screentone, high contrast, dramatic lighting" placeholder="å¦‚ï¼šblack and white manga, dramatic lighting"/>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="btnRenderFE">å¼€å§‹å¹¶å‘æ¸²æŸ“</button>
      <button id="btnStop" class="secondary">åœæ­¢é˜Ÿåˆ—</button>
      <button id="btnSaveUrls" class="secondary" title="å¤åˆ¶æ‰€æœ‰å›¾ç‰‡é“¾æ¥åˆ°å‰ªè´´æ¿">å¤åˆ¶å…¨éƒ¨é“¾æ¥</button>
    </div>
    <div id="progress" class="help" style="margin-top:8px">è¿›åº¦ï¼š0/0</div>
    <hr/>
    <div id="renderOut" class="grid-tiles"></div>
  </section>

</div>

<!-- åº•éƒ¨ï¼šç”Ÿæˆå•æ ¼ç”»é¢ -->
<div class="container footer-card">
  <section class="card">
    <h2>â‘¢ ç”Ÿæˆå•æ ¼ç”»é¢ <span class="badge">å•æ¬¡æµ‹è¯•</span></h2>
    <div class="kv" style="margin-top:6px">
      <label>æç¤ºè¯</label>
      <input id="prompt" placeholder="ä¸­è‹±æ–‡éƒ½å¯ï¼Œä¾‹å¦‚ï¼šblack and white manga panel, rainy street"/>
      <label>å°ºå¯¸</label>
      <select id="size">
        <option>1024x1024</option>
        <option>768x1344</option>
        <option>1344x768</option>
      </select>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="btnImg">ç”Ÿæˆä¸€æ ¼</button>
      <button id="btnClearOne" class="secondary">æ¸…ç©ºè¯¥åŒºåŸŸ</button>
    </div>
    <div id="imgout" style="margin-top:10px"></div>
  </section>
</div>

<script>
const API='/api';
let STOP=false;

async function postJSON(p,b){
  const r=await fetch(API+p,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(b)});
  if(!r.ok) throw new Error(await r.text()); return r.json();
}
const $=sel=>document.querySelector(sel);
const esc=s=>String(s??'').replace(/[&<>"]/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m]));

$('#btnSb').onclick=async()=>{
  const text=$('#novel').value.trim(), style=$('#style').value, out=$('#sbout');
  if(!text){ out.textContent='è¯·å…ˆç²˜è´´å°è¯´ç‰‡æ®µ'; return; }
  out.textContent='(ç”Ÿæˆä¸­...)';
  try{
    const res=await postJSON('/storyboard',{text,style});
    out.textContent=JSON.stringify(JSON.parse(res.storyboard_json||'{}'),null,2);
    window.scrollTo({top:0,behavior:'smooth'});
  }catch(e){ out.textContent='å¤±è´¥ï¼š'+e.message; }
};
$('#btnClear').onclick=()=>{
  $('#novel').value=''; $('#sbout').textContent='(ç­‰å¾…ç”Ÿæˆ...)';
  $('#renderOut').innerHTML=''; $('#progress').textContent='è¿›åº¦ï¼š0/0';
};

function digPanels(sb){
  const list=[]; (sb.pages||[]).forEach((p,pi)=>{ (p.panels||[]).forEach((g,gi)=>{ list.push({pi,gi,id:g.id??(gi+1),desc:g.desc||''}); });});
  return list;
}
function renderTiles(list){
  const host=$('#renderOut'); let html='';
  list.forEach((p,idx)=>{
    html+=`<div class="tile" id="tile-${idx}">
      <p><b>#${esc(p.id)}</b> ${esc(p.desc)}</p>
      <div id="thumb-${idx}" class="help">æ’é˜Ÿä¸­â€¦</div>
    </div>`;
  });
  host.innerHTML=html;
}
function setTile(idx, ok, urlOrMsg){
  const t=$('#thumb-'+idx); if(!t) return;
  if(ok){
    t.innerHTML=`<a href="${urlOrMsg}" target="_blank">${urlOrMsg}</a><br>
                 <img loading="lazy" src="${urlOrMsg}" alt="panel ${idx}">`;
  }else{
    t.innerHTML=`<span style="color:var(--danger)">å¤±è´¥ï¼š</span><span class="help">${esc(urlOrMsg)}</span>`;
  }
}
async function runPool(limit, tasks, onDone){
  let i=0, done=0;
  async function worker(){
    while(true){
      if(STOP) break;
      const cur=i++; if(cur>=tasks.length) break;
      try{ await tasks[cur](); }catch(_){} finally{ done++; onDone?.(done,tasks.length); }
    }
  }
  await Promise.all(Array.from({length:Math.min(limit,tasks.length)},()=>worker()));
  return done;
}
$('#btnRenderFE').onclick=async()=>{
  STOP=false;
  const sbtxt=$('#sbout').textContent.trim();
  const size=$('#sizeBatch').value||'1024x1024';
  const prefix=($('#pprefix').value||'').trim();
  const prog=$('#progress');
  if(!sbtxt||sbtxt[0]!=='{'){ prog.textContent='è¯·å…ˆåœ¨å·¦ä¾§ç”Ÿæˆåˆ†é•œ JSON'; return; }
  let sb; try{ sb=JSON.parse(sbtxt); }catch(e){ prog.textContent='åˆ†é•œ JSON è§£æå¤±è´¥'; return; }
  const panels=digPanels(sb); if(!panels.length){ prog.textContent='åˆ†é•œä¸ºç©º'; return; }
  renderTiles(panels); prog.textContent=`è¿›åº¦ï¼š0/${panels.length}`;
  const tasks=panels.map((p,idx)=> async()=>{
    const prompt=((prefix+' '+(p.desc||'')).trim());
    try{ const r=await postJSON('/image',{prompt,size}); setTile(idx,true,r.url); }
    catch(e){ setTile(idx,false,e.message||'error'); }
  });
  const limit=Math.max(1, Math.min(6, parseInt($('#concurrency').value||'3',10)));
  await runPool(limit,tasks,(d,t)=>{ prog.textContent=`è¿›åº¦ï¼š${d}/${t}`; });
  if(!STOP) prog.textContent+=' âœ… å®Œæˆ';
  document.querySelector('#renderOut')?.scrollIntoView({behavior:'smooth',block:'start'});
};
$('#btnStop').onclick=()=>{ STOP=true; $('#progress').textContent+=' Â· å·²è¯·æ±‚åœæ­¢'; };

$('#btnSaveUrls').onclick=()=>{
  const links=[...document.querySelectorAll('#renderOut a')].map(a=>a.href).filter(Boolean);
  if(!links.length){ alert('æš‚æ— å¯å¤åˆ¶çš„é“¾æ¥'); return; }
  navigator.clipboard.writeText(links.join('\n')).then(()=>alert('å·²å¤åˆ¶ '+links.length+' æ¡é“¾æ¥'));
};

$('#btnImg').onclick=async()=>{
  const prompt=$('#prompt').value||'black and white manga panel';
  const size=$('#size').value||'1024x1024';
  const div=$('#imgout'); div.innerHTML='<span class="help">ç”Ÿæˆä¸­â€¦</span>';
  try{ const r=await postJSON('/image',{prompt,size});
    div.innerHTML=`<a href="${r.url}" target="_blank">${r.url}</a><br><img loading="lazy" src="${r.url}" alt="single">`;
    div.scrollIntoView({behavior:'smooth', block:'start'});
  }catch(e){ div.innerHTML=`<span style="color:var(--danger)">å¤±è´¥ï¼š</span><span class="help">${esc(e.message||'error')}</span>`; }
};
$('#btnClearOne').onclick=()=>{ $('#prompt').value=''; $('#imgout').innerHTML=''; };
</script>
</body></html>
